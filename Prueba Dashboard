import requests
from pprint import pprint
from datetime import datetime
import json

def separador(titulo):
    """Imprime un separador bonito"""
    print("\n" + "="*60)
    print(f"  {titulo}")
    print("="*60 + "\n")

# =============================================================================
# 1. API del CLIMA (OpenWeatherMap)
# =============================================================================
def obtener_clima(ciudad="Madrid"):
    separador(f"CLIMA EN {ciudad.upper()}")
    
    # API key gratuita (regÃ­strate en openweathermap.org)
    API_KEY = "demo"  # Usa 'demo' para probar, luego consigue tu propia key
    url = f"http://api.openweathermap.org/data/2.5/weather"
    
    params = {
        'q': ciudad,
        'appid': API_KEY,
        'units': 'metric',  # Celsius
        'lang': 'es'        # Respuestas en espaÃ±ol
    }
    
    try:
        response = requests.get(url, params=params, timeout=5)
        
        # Verificar cÃ³digo de estado
        if response.status_code == 200:
            data = response.json()
            print(f"ğŸŒ¡ï¸  Temperatura: {data['main']['temp']}Â°C")
            print(f"ğŸŒ¡ï¸  SensaciÃ³n tÃ©rmica: {data['main']['feels_like']}Â°C")
            print(f"â˜ï¸  DescripciÃ³n: {data['weather'][0]['description']}")
            print(f"ğŸ’§ Humedad: {data['main']['humidity']}%")
            print(f"ğŸ’¨ Viento: {data['wind']['speed']} m/s")
        else:
            print(f"âŒ Error {response.status_code}: {response.json()}")
            
    except requests.exceptions.Timeout:
        print("â±ï¸  Error: La peticiÃ³n tardÃ³ demasiado")
    except requests.exceptions.RequestException as e:
        print(f"âŒ Error de conexiÃ³n: {e}")

# =============================================================================
# 2. API de GITHUB - AnÃ¡lisis de usuario
# =============================================================================
def analizar_usuario_github(username):
    separador(f"ANÃLISIS GITHUB: @{username}")
    
    # Info del usuario
    url_user = f"https://api.github.com/users/{username}"
    response = requests.get(url_user)
    
    if response.status_code == 404:
        print(f"âŒ Usuario '{username}' no encontrado")
        return
    
    user = response.json()
    
    print(f"ğŸ‘¤ Nombre: {user.get('name', 'N/A')}")
    print(f"ğŸ“ UbicaciÃ³n: {user.get('location', 'N/A')}")
    print(f"ğŸ¢ Empresa: {user.get('company', 'N/A')}")
    print(f"ğŸ“¦ Repos pÃºblicos: {user['public_repos']}")
    print(f"ğŸ‘¥ Seguidores: {user['followers']}")
    print(f"â­ Siguiendo: {user['following']}")
    print(f"ğŸ“… Cuenta creada: {user['created_at'][:10]}")
    
    # Obtener repos mÃ¡s populares
    print(f"\nğŸ“Š Top 5 repositorios:")
    url_repos = f"https://api.github.com/users/{username}/repos"
    response = requests.get(url_repos, params={'sort': 'stars', 'per_page': 5})
    repos = response.json()
    
    for i, repo in enumerate(repos[:5], 1):
        print(f"  {i}. {repo['name']}")
        print(f"     â­ {repo['stargazers_count']} stars | "
              f"ğŸ´ {repo['forks_count']} forks | "
              f"ğŸ“ {repo.get('language', 'N/A')}")

# =============================================================================
# 3. API de CHISTES (Chuck Norris API)
# =============================================================================
def obtener_chiste():
    separador("CHISTE RANDOM")
    
    url = "https://api.chucknorris.io/jokes/random"
    response = requests.get(url)
    
    if response.status_code == 200:
        data = response.json()
        print(f"ğŸ˜‚ {data['value']}")
    else:
        print("âŒ No se pudo obtener el chiste")

# =============================================================================
# 4. API de CRIPTOMONEDAS (CoinGecko)
# =============================================================================
def obtener_cripto(moneda="bitcoin"):
    separador(f"PRECIO {moneda.upper()}")
    
    url = f"https://api.coingecko.com/api/v3/simple/price"
    params = {
        'ids': moneda,
        'vs_currencies': 'eur,usd',
        'include_24hr_change': 'true'
    }
    
    response = requests.get(url, params=params)
    
    if response.status_code == 200:
        data = response.json()[moneda]
        print(f"ğŸ’° Precio EUR: â‚¬{data['eur']:,.2f}")
        print(f"ğŸ’µ Precio USD: ${data['usd']:,.2f}")
        
        cambio = data['usd_24h_change']
        emoji = "ğŸ“ˆ" if cambio > 0 else "ğŸ“‰"
        print(f"{emoji} Cambio 24h: {cambio:+.2f}%")
    else:
        print(f"âŒ Error al obtener precio de {moneda}")

# =============================================================================
# 5. POST REQUEST - Crear post en API de prueba
# =============================================================================
def crear_post_prueba():
    separador("POST REQUEST - CREAR RECURSO")
    
    url = "https://jsonplaceholder.typicode.com/posts"
    
    nuevo_post = {
        'title': 'Aprendiendo APIs con Python',
        'body': 'Este post fue creado con requests y VS Code',
        'userId': 1
    }
    
    # Headers opcionales
    headers = {
        'Content-Type': 'application/json',
        'User-Agent': 'MiScript/1.0'
    }
    
    print("ğŸ“¤ Enviando POST request...")
    response = requests.post(url, json=nuevo_post, headers=headers)
    
    print(f"ğŸ“¨ Status Code: {response.status_code}")
    
    if response.status_code == 201:  # 201 = Created
        print("âœ… Recurso creado exitosamente!")
        resultado = response.json()
        print(f"ğŸ†” ID asignado: {resultado['id']}")
        pprint(resultado)
    else:
        print("âŒ Error al crear recurso")

# =============================================================================
# 6. GUARDAR RESULTADOS EN ARCHIVO
# =============================================================================
def guardar_datos_github(username):
    separador("GUARDAR DATOS EN ARCHIVO")
    
    url = f"https://api.github.com/users/{username}"
    response = requests.get(url)
    
    if response.status_code == 200:
        data = response.json()
        
        # Guardar JSON
        filename = f"github_{username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=2, ensure_ascii=False)
        
        print(f"ğŸ’¾ Datos guardados en: {filename}")
        print(f"ğŸ“Š TamaÃ±o: {len(json.dumps(data))} bytes")
    else:
        print(f"âŒ Error al obtener datos de {username}")

# =============================================================================
# MENÃš PRINCIPAL
# =============================================================================
def menu():
    print("\n" + "ğŸš€ EXPLORADOR DE APIs ".center(60, "="))
    print("\n1. Ver clima (OpenWeatherMap)")
    print("2. Analizar usuario GitHub")
    print("3. Chiste random")
    print("4. Precio criptomoneda")
    print("5. Crear post (POST request)")
    print("6. Guardar datos GitHub en archivo")
    print("7. Ejecutar TODO")
    print("0. Salir")
    
    return input("\nğŸ‘‰ Elige opciÃ³n: ")

# =============================================================================
# EJECUTAR
# =============================================================================
if __name__ == '__main__':
    while True:
        opcion = menu()
        
        if opcion == '1':
            ciudad = input("Ciudad (Enter = Madrid): ") or "Madrid"
            obtener_clima(ciudad)
        
        elif opcion == '2':
            user = input("Usuario GitHub: ")
            analizar_usuario_github(user)
        
        elif opcion == '3':
            obtener_chiste()
        
        elif opcion == '4':
            cripto = input("Cripto (bitcoin/ethereum/cardano): ") or "bitcoin"
            obtener_cripto(cripto)
        
        elif opcion == '5':
            crear_post_prueba()
        
        elif opcion == '6':
            user = input("Usuario GitHub: ")
            guardar_datos_github(user)
        
        elif opcion == '7':
            obtener_clima("Madrid")
            analizar_usuario_github("microsoft")
            obtener_chiste()
            obtener_cripto("bitcoin")
            crear_post_prueba()
        
        elif opcion == '0':
            print("\nğŸ‘‹ Â¡Hasta luego!")
            break
        
        else:
            print("âŒ OpciÃ³n invÃ¡lida")
        
        input("\nâ Presiona Enter para continuar...")